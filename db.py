import gspreadimport credentialsimport reimport datetimeimport logsimport pandas as pdimport operatorimport collections# pulls customers from 4g and dsl sheets and combine themdef get_customers(due_date,main_table_4g,main_table_dsl):    customers_4g = _get_customers_from_sheet(due_date, main_table_4g)    customers_dsl = _get_customers_from_sheet(due_date, main_table_dsl)    email_list = []    customers = []    for customer_4g in customers_4g:        for customer_dsl in customers_dsl:            if customer_4g["email"] == customer_dsl["email"]:                email_list.append(customer_4g["email"])                customer = {"name": customer_4g["name"], "email": customer_4g["email"], "pc_list": customer_4g["pc_list"] + customer_dsl["pc_list"]}                customers.append(customer)    for email in email_list:        customers_4g[:] = [customer for customer in customers_4g if customer.get('email') != email]        customers_dsl[:] = [customer for customer in customers_dsl if customer.get('email') != email]    customers = customers + customers_4g + customers_dsl    return customers# retrieves customers list from specific worksheet based on datedef _get_customers_from_sheet(due_date, worksheet):    all_values = worksheet    customers = []    for line_due_date, pc_name, credit, name, email, tv_id, password, broken, available, taken, trial, weekly, biweekly, monthly, start_date, comment, password_proxy in zip(            all_values[26], all_values[1], all_values[3], all_values[6], all_values[7], all_values[19], all_values[20],            all_values[10], all_values[11], all_values[12], all_values[22], all_values[23], all_values[24],            all_values[25],            all_values[27], all_values[8], all_values[21]):        pc_list = []        if line_due_date != "" and re.findall("^([1-9]|[1][0-2])\/([1-9]|[1-3][0-9])\/[2][0][1-9][1-9]$", line_due_date):            try: line_due_date = datetime.datetime.strptime(line_due_date, '%m/%d/%Y').date()            except: continue            if line_due_date == due_date and taken != "":                pc_status = _get_pc_status(broken, available, taken)                plan = _get_plan(trial, weekly, biweekly, monthly)                if password == "":                    if password_proxy != "":                        password = password_proxy                    else:                        password = "100777"                pc = {"pc_name": pc_name, "tv_id": tv_id, "password": password, "due_date": line_due_date,                      "start_date": start_date, "pc_status": pc_status, "plan": plan, "credit": credit, "customer": comment}                for customer in customers:                    if customer['email'] == email:                        pc_list = customer["pc_list"]                        customers[:] = [customer for customer in customers if customer.get('email') != email]                pc_list.append(pc)                customer = {"name": name, "email": email, "pc_list": pc_list}                customers.append(customer)    return customersdef _get_pc_status(broken, available, taken):    if broken != "":        status = "broken"    elif available != "":        status = "available"    elif taken != "":        status = "taken"    else:        status = "undefined"    return statusdef _get_plan(trial, weekly, biweekly, monthly):    plan = "undefined"    if trial + weekly + biweekly + monthly != "":        if trial != "":            plan = "trial"        if weekly != "":            plan = "weekly"        if biweekly != "":            plan = "biweekly"        if monthly != "":            plan = "monthly"    return plan# check missing elements + not closed linesdef check_errors(main_table_4g, main_table_dsl):    errors_4g = _check_errors_from_sheet(main_table_4g)    errors_dsl = _check_errors_from_sheet(main_table_dsl)    all_errors = errors_4g + errors_dsl    return all_errorsdef _check_errors_from_sheet(worksheet):    all_values = worksheet    errors = []    for line_due_date, pc_name, name, email, tv_id, password_tv, broken, available, taken, trial, weekly, biweekly, monthly, comment, plugin, password_proxy, bill_date, provider in zip(            all_values[26], all_values[1], all_values[6], all_values[7], all_values[19], all_values[20],            all_values[10], all_values[11], all_values[12], all_values[22], all_values[23], all_values[24],            all_values[25],            all_values[8], all_values[9], all_values[21], all_values[18], all_values[4]):        if re.findall("^(DSL|3G|4G)-(HZB|NY1|NY2|NY22|NY222|TX|OH|PA|FL|IL|GA|AL|MA|AZ|WA|CA2|CAN|AU1)-([0-9]|[0-9][0-9])$", pc_name):            if line_due_date != "" and re.findall("^([1-9]|[1][0-2])\/([1-9]|[1-3][0-9])\/[2][0][1-9][1-9]$", line_due_date):                try: line_due_date = datetime.datetime.strptime(line_due_date, '%m/%d/%Y').date()                except:continue                if line_due_date >= datetime.date.today():                    if broken == "" and taken == "":                        line = {"pc_name": pc_name, "problem":"Either due date or status is wrong"}                        errors.append(line)                    if email == "":                        line = {"pc_name": pc_name, "problem": "Email address is missing"}                        errors.append(line)                    if name == "":                        line = {"pc_name": pc_name, "problem": "Customer name is missing"}                        errors.append(line)                    if password_tv == "" and password_proxy == "":                        line = {"pc_name": pc_name, "problem": "Password is missing"}                        errors.append(line)                    if _get_plan(trial, weekly, biweekly, monthly) == "undefined":                        line = {"pc_name": pc_name, "problem": "Plan is not defined or missing"}                        errors.append(line)                elif line_due_date < datetime.date.today() - datetime.timedelta(days=1) and taken != "":                    unclosed_time = datetime.date.today() - line_due_date                    line = {"pc_name": pc_name, "problem": "Has not been closed {0} day/s ago".format(unclosed_time.days)}                    errors.append(line)            if tv_id == "":                if broken != "" or taken != "" or available != "" or plugin != "":                    line = {"pc_name": pc_name, "problem": "Team-Viewer ID is missing"}                    errors.append(line)            else:                if not re.findall("^(([0-9][0-9][0-9][0-9])|([0-9][0-9][0-9])) ([0-9][0-9][0-9]) ([0-9][0-9][0-9])$", tv_id):                    line = {"pc_name": pc_name, "problem": "Team-Viewer ID doesn't match the pattern xxxx xxx xxx or xxx xxx xxx"}                    errors.append(line)            if re.findall("^(3G|4G)-(HZB|NY1|NY2|NY22|NY222|TX|OH|PA|FL|IL|GA|AL|MA|AZ|WA|CA2|CAN|AU1)-([0-9]|[0-9][0-9])$", pc_name) and bill_date != "" and re.findall("^([1-9]|[1][0-2])\/([1-9]|[1-3][0-9])\/[2][0][1-9][1-9]$", bill_date):                bill_date = datetime.datetime.strptime(bill_date, '%m/%d/%Y').date()                expected_date = datetime.date.today() + datetime.timedelta(days=3)                if bill_date <= expected_date:                    time_to_pay = bill_date - datetime.date.today()                    line = {"pc_name": pc_name, "problem": "Consider to pay {0} next billing cycle (starts in {1} day/s)".format(provider, time_to_pay.days)}                    errors.append(line)    return errors# statuses are taken, broken, available or plugindef get_lines_by_status(status, main_table_4g, main_table_dsl):    lines_4g = _get_lines_by_status_from_sheet(main_table_4g, status)    lines_dsl = _get_lines_by_status_from_sheet(main_table_dsl, status)    return lines_4g + lines_dsldef _get_lines_by_status_from_sheet(worksheet, status):    all_values = worksheet    lines = []    for line_due_date, pc_name, name, email, tv_id, password_tv, broken, available, taken, problem in zip(            all_values[26], all_values[1], all_values[6], all_values[7], all_values[19], all_values[20],            all_values[10], all_values[11], all_values[12], all_values[0]):        if re.findall("^(DSL|3G|4G)-(HZB|NY1|NY2|NY22|NY222|TX|OH|PA|FL|IL|GA|AL|MA|AZ|WA|CA2|CAN|AU1)-([0-9]|[0-9][0-9])$", pc_name):            line_status = _get_pc_status(broken, available, taken)            if line_status == status:                if password_tv == "":                    password_tv = "100777"                if line_status == "broken":                    pc_name = pc_name.replace(u'\xa0', u' ')                    tv_id = str(tv_id.replace(u'\xa0', u' '))                    password_tv = str(password_tv)                    password_tv = password_tv.replace(u'\xa0', u' ')                    problem = problem.replace(u'\xa0', u' ')                    if broken != "1" and re.findall("^([1-9]|[1][0-2])\/([1-9]|[1-3][0-9])\/[2][0][1-9][1-9]$", broken):                        downtime = datetime.date.today() - datetime.datetime.strptime(broken, '%m/%d/%Y').date()                        downtime = downtime.days                    else:                        downtime = "n/a"                    important = False                    if email == "siva.ramamurthy@gmail.com" or email == "jianjia.hao@gmail.com":                        important = True                    line = {"pc_name": pc_name, "tv_id": tv_id, "password": password_tv, "problem": problem, "downtime": downtime, "important": important}                else:                    line = {"pc_name": pc_name, "tv_id": tv_id, "password": password_tv}                lines.append(line)    return linesdef get_sold_lines_today(main_table_4g, main_table_dsl):    lines_4g = _get_sold_lines_today_from_sheet(main_table_4g)    lines_dsl = _get_sold_lines_today_from_sheet(main_table_dsl)    return lines_4g + lines_dsldef _get_sold_lines_today_from_sheet(worksheet):    all_values = worksheet    lines = []    for line_due_date, pc_name, credit, name, email, tv_id, password_tv, broken, available, taken, trial, weekly, biweekly, monthly, cell27, customer_comment, plugin, password_proxy, problem, cell28, cell29 in zip(            all_values[26], all_values[1], all_values[3], all_values[6], all_values[7], all_values[19], all_values[20],            all_values[10], all_values[11], all_values[12], all_values[22], all_values[23], all_values[24],            all_values[25],            all_values[27], all_values[8], all_values[9], all_values[21], all_values[0], all_values[28], all_values[29]):        if re.findall(                "^(DSL|3G|4G)-(HZB|NY1|NY2|NY22|NY222|TX|OH|PA|FL|IL|GA|AL|MA|AZ|WA|CA2|CAN|AU1)-([0-9]|[0-9][0-9])$",                pc_name):            line_status = _get_pc_status(broken, available, taken)            plan = _get_plan(trial, weekly, biweekly, monthly)            if plan == "weekly":                price = weekly            elif plan == "biweekly":                price = biweekly            elif plan == "monthly":                price = monthly            elif plan == "trial":                price = trial            else:                price = "n/a"            if line_status == 'taken' and line_due_date != "":                if _is_sold_today([cell27, cell28, cell29]):                    if email == "":                        email = "no_email_address"                    if cell28 == "":                        line = {"pc_name": pc_name, "email": email, "plan": plan, "price": price, "type": "purchase"}                    else:                        line = {"pc_name": pc_name, "email": email, "plan": plan, "price": price, "type": "renewed"}                    logs.write_to_daily_sales("{0} {1} {2} {3} {4}".format(line["pc_name"], line["email"], line["plan"], line["price"], line["type"]))                    lines.append(line)    return linesdef _is_sold_today(cells):    try:        for cell in cells:            if cell == "":                return False            if re.findall("^.*([1-9]|[1][0-2])\/([1-9]|[1-3][0-9])\/[2][0][1-9][1-9]$", cell):                date = cell.split()                if datetime.date.today() - datetime.timedelta(days=1) == datetime.datetime.strptime(date[-1], '%m/%d/%Y').date():                    return True    except:        print("can't read due date ")