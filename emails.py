import settingsimport logsfrom email.mime.multipart import MIMEMultipartfrom email.mime.text import MIMETextimport smtplibimport calendarimport datetimedef send_reminders(email_conn, customers, due_date):    emails_sent = 0    subject = "Payment reminder"    if len(customers) == 0:        return emails_sent    for customer in customers:        if customer["name"] == "":            customer["name"] = "customer"        if len(customer["pc_list"]) == 1:            customer_response = "Your line <b>{0}</b> is about to expire on <b>{1}</b><BR>Please remit payment at your earliest convenience.".format(customer["pc_list"][0]["pc_name"], due_date.strftime("%B %d"))        else:            pc_list = customer["pc_list"]            pc_str = ""            for pc in pc_list:                pc_str = pc_str + "{0}, ".format(pc["pc_name"])            pc_str = pc_str[:-2]            customer_response = "Your lines<BR><b>{0}</b><BR>are about to expire on <b>{1}</b><BR>Please remit payment at your earliest convenience.".format(pc_str, due_date.strftime("%B %d"))        message = """\        <META HTTP-EQUIV="Content-Type" CONTENT="text/html;charset=iso-8859-1">        <HTML><HEAD></HEAD>        <BODY dir=ltr>        <DIV dir=ltr>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV>&nbsp;</DIV>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV dir=ltr>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV dir=ltr>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV dir=ltr>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        Dear {0},<BR>        <BR>        {1}        <BR>        <BR>        Payment options:        <BR>        BTC: {2}        <BR>        PayPal: {3}        <BR>        <BR>        Thank you,<BR>        <BR>        - Please keep conversation history in all outgoing emails -        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt"><br>        Notifier at DSL Rentals<BR>        Web: <A href="https://www.dslrentals.com/?utm_source=reminder&utm_medium=email">My Account</A><BR>        Refer Friends &amp; Co-workers to Get Our Services!</DIV>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">&nbsp;</DIV>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt"><FONT        face="Times New Roman"><FONT style="FONT-SIZE: 12pt">Like us on <A        href="http://www.facebook.com/dslrentals"><img src="http://dslrentals.com/wp-content/themes/hostme/images/followus/facebook_16.png" alt="Facebook"/></A>, follow us on <A        href="http://www.twitter.com/dslrentals"><img src="http://dslrentals.com/wp-content/themes/hostme/images/followus/twitter_16.png" alt="Twitter"/></A>, connect with us on <A        href="http://www.linkedin.com/in/dslrentals"><img src="http://dslrentals.com/wp-content/themes/hostme/images/followus/linkedin_16.png" alt="LinkedIn"/></A></FONT></FONT>        <BR><BR></DIV></DIV></DIV></DIV></DIV></DIV></DIV></DIV></DIV></DIV></DIV></DIV>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        --        <BR>        </DIV>        </BODY></HTML>        """.format(customer["name"], customer_response, settings.btc, settings.paypal)        if settings.mode == "test_all":            to_customer = ["artsiom.lubinsky@gmail.com"]        else:            to_customer = [customer["email"]]        send_email(email_conn, to_customer, subject, message)    return emails_sentdef send_daily_report(email_conn, errors, customers_to_close, broken_lines, sold_lines, sprint_less_used, sprint_most_used, shared_usage, is_updated_data, verizon_usage, verizon_total_usage):    customer_to_close_str = ""    errors_str = ""    broken_lines_str = ""    sold_lines_str = ""    date = datetime.date.today() - datetime.timedelta(days=1)    subject = "Daily Google Sheets report: {0} ({1})".format(calendar.day_name[date.weekday()], date)    if len(errors) != 0:        errors_str = "<b>{0} Possible errors:</b><table style='width:auto; FONT-SiZE: 8pt'><tr align='left'><th>Line</th><th>Problem</th></tr>".format(len(errors))        for error in errors:            errors_str = errors_str + "<tr><td>{0}</td><td>{1}</td></tr>".format(error["pc_name"], error["problem"])        errors_str = errors_str + "</table>"    if len(customers_to_close) != 0:        customer_to_close_str = "<BR><b>These lines should be closed today:</b><table style='width:auto; FONT-SiZE: 8pt'><tr align='left'><th>Line</th><th>Team-Viewer</th><th>Password</th></tr>"        for customer in customers_to_close:            if len(customer["pc_list"]) == 1:                pc_name = customer["pc_list"][0]["pc_name"]                pc_tvid = customer["pc_list"][0]["tv_id"]                pc_pass = customer["pc_list"][0]["password"]                customer_to_close_str = customer_to_close_str + "<tr><td>{0}</td><td>{1}</td> <td>{2}</td></tr>".format(pc_name, pc_tvid, pc_pass)            else:                pc_list = customer["pc_list"]                pc_str = ""                for pc in pc_list:                    pc_str = pc_str + "<tr><td>{0}</td><td>{1}</td><td>{2}</td></tr>".format(pc["pc_name"], pc["tv_id"], pc["password"])                customer_to_close_str = customer_to_close_str + pc_str        customer_to_close_str = customer_to_close_str +"</table>"    if len(broken_lines) != 0:        broken_lines_str = "<BR><b>{0} Broken lines:</b><table style='width:auto; FONT-SiZE: 8pt'><tr align='left'><th>Line</th><th>Team-Viewer</th><th>Password</th><th>Downtime</th><th>Problem</th></tr>".format(len(broken_lines))        for broken_line in broken_lines:            if broken_line["important"]:                broken_lines_str = broken_lines_str + "<tr style='font-weight:bold'><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td></tr></b>".format(                    broken_line["pc_name"], broken_line["tv_id"], broken_line["password"], broken_line["downtime"],                    broken_line["problem"])            else:                broken_lines_str = broken_lines_str + "<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td></tr>".format(broken_line["pc_name"], broken_line["tv_id"], broken_line["password"], broken_line["downtime"], broken_line["problem"])        broken_lines_str = broken_lines_str + "</table>"    if len(sold_lines) != 0:        sold_lines_str = "<BR><b>{0} Sold lines:</b><table style='width:auto; FONT-SiZE: 8pt'><tr align='left'><th>Line</th><th>Email</th><th>Plan</th><th>Price</th><th>Type</th></tr>".format(len(sold_lines))        for sold_line in sold_lines:            sold_lines_str = sold_lines_str + "<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>${3}</td><td>{4}</td></tr>".format(                    sold_line["pc_name"], sold_line["email"], sold_line["plan"], sold_line["price"], sold_line["type"])        sold_lines_str = sold_lines_str + "</table>"    if len(sprint_most_used) != 0 or len(sprint_less_used) != 0:        sprint_usage_str = "<BR><b>Sprint usage:</b>"        if not is_updated_data:            sprint_usage_str = sprint_usage_str + " (not updated)"        sprint_usage_str = sprint_usage_str + "<table style='width:auto; FONT-SiZE: 8pt'><tr><th colspan='5'>Most used</th><th colspan='5'>Less used</th></tr><tr align='left'><th>Line</th><th>User</th><th>Total used</th><th>Used today</th><th>Plan</th><th>Line</th><th>User</th><th>Total used</th><th>Used today</th><th>Plan</th></tr>"        for (k1, v1), (k2, v2)in zip(sprint_most_used.items(), sprint_less_used.items()):            usage1 = '<td>{0} GB</td>'.format(v1["usage"])            usage2 = '<td>{0} GB</td>'.format(v2["usage"])            if v1['overusage']:                usage1 = '<td bgcolor=red>{0} GB</td>'.format(v1["usage"])            if v2['overusage']:                usage2 = '<td bgcolor=red>{0} GB</td>'.format(v2["usage"])            sprint_usage_str = sprint_usage_str + "<tr><td>{0}</td><td>{1}</td>{2}<td>{3} GB</td><td>{4}</td><td>{5}</td><td>{6}</td>{7}<td>{8} GB</td><td>{9}</td></tr>".format(k1, v1['email'], usage1, v1['used_today'], v1['plan'], k2, v2['email'], usage2, v2['used_today'], v2['plan'])        sprint_usage_str = sprint_usage_str + "</table>"        sprint_usage_str = sprint_usage_str + "<BR>Shared lines used {0} of {1} GB".format(round(shared_usage), settings.sprint_plan_limit)        sprint_usage_str = sprint_usage_str + "<BR>New cycle starts in {0} days".format((settings.sprint_billing_date - datetime.date.today()).days)    verizon_usage_str = ""    if verizon_total_usage != 0:        verizon_usage_str = "<BR><BR><b>Verizon usage:</b>"        if verizon_usage != 0:            verizon_usage_str = verizon_usage_str + "<table style='width:auto; FONT-SiZE: 8pt'><tr align='left'><th>Line</th><th>User</th><th>Total used</th>"            for n in verizon_usage:                verizon_usage_str = verizon_usage_str + '<tr><td>{0}</td><td>{1}</td><td>{2} GB</td></tr>'.format(n["name"],n["email"],round(float(n["usage"]),1))            verizon_usage_str = verizon_usage_str + "</table>"        verizon_usage_str = verizon_usage_str + "<BR>Shared lines used : {0} of {1} GB".format(round(float(verizon_total_usage[0])), verizon_total_usage[1])        verizon_usage_str = verizon_usage_str + "<BR>New cycle starts in {0} days".format(verizon_total_usage[2])    message = """\        <META HTTP-EQUIV="Content-Type" CONTENT="text/html;charset=iso-8859-1">        <HTML></HEAD>        <BODY dir=ltr>        <DIV dir=ltr>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV>&nbsp;</DIV>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV dir=ltr>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV dir=ltr>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV dir=ltr>        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">        <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 12pt">        {0}        {1}        {2}        {3}        {4}        {5}        <BR>        </BODY></HTML>        """.format(errors_str, customer_to_close_str, sold_lines_str, broken_lines_str, sprint_usage_str, verizon_usage_str)    if settings.mode == "test" or settings.mode == "test_all":        to_manager = ["artsiom.lubinsky@gmail.com"]    else:        to_manager = ["manager@dslrentals.com", "support@dslrentals.com", "agalanin@live.com", "anton@dslrentals.com"]    send_email(email_conn, to_manager, subject, message)    returndef send_sales_report(email_conn, from_date, to_date, table_purchase_4g, table_renewed_4g, table_purchase_dsl, table_renewed_dsl, type):    if type == "weekly":        subject = "Weekly Sales Report".format()    else:        subject = "{0} Sales Report".format(calendar.month_name[to_date.month])    table_str = "<table style='width:auto'>" + "<caption>{0} - {1}</caption>".format(from_date.strftime("%B %d"), to_date.strftime("%B %d"))    header = "<tr bgcolor='#316ECE' style='text-align: center'><td></td><td colspan='3'>4G</td>" + "<td colspan='3'>DSL</td>" + "<td colspan='3'>Totals</td></tr>" + "<tr><td></td><td>Sum</td><td>Num</td><td>Mean</td>" + "<td>Sum</td><td>Num</td><td>Mean</td>" + "<td>Sum</td><td>Num</td><td>Mean</td></tr>"    purchase_str= ""    purchase_sum_4g = 0    purchase_num_4g = 0    purchase_sum_dsl = 0    purchase_num_dsl = 0    for n in range(0, 4):        if table_purchase_4g[n][2] != 0:            purchase_mean_4g = table_purchase_4g[n][1]/table_purchase_4g[n][2]        else: purchase_mean_4g = 0        if table_purchase_dsl[n][2] != 0:            purchase_mean_dsl = int(table_purchase_dsl[n][1]/table_purchase_dsl[n][2])        else: purchase_mean_dsl = 0        purchase_sum_4g = purchase_sum_4g + table_purchase_4g[n][1]        purchase_num_4g = purchase_num_4g + table_purchase_4g[n][2]        purchase_sum_dsl = purchase_sum_dsl + table_purchase_dsl[n][1]        purchase_num_dsl = purchase_num_dsl + table_purchase_dsl[n][2]        if (table_purchase_4g[n][2]+table_purchase_dsl[n][2]) != 0:            purchase_mean = int((table_purchase_4g[n][1]+table_purchase_dsl[n][1])/(table_purchase_4g[n][2]+table_purchase_dsl[n][2]))        else: purchase_mean = 0        purchase_str = purchase_str + "<tr><td>{0}</td><td>${1}</td><td>{2}</td><td>${3}</td><td>${4}</td><td>{5}</td><td>${6}</td><td>${7}</td><td>{8}</td><td>${9}</td></tr>".format(table_purchase_4g[n][0], table_purchase_4g[n][1], table_purchase_4g[n][2], int(purchase_mean_4g), table_purchase_dsl[n][1], table_purchase_dsl[n][2], purchase_mean_dsl,table_purchase_4g[n][1]+table_purchase_dsl[n][1], int(table_purchase_4g[n][2]+table_purchase_dsl[n][2]), purchase_mean)    if purchase_num_4g != 0:        purchase_mean_4g = int(purchase_sum_4g/purchase_num_4g)    else: purchase_mean_4g = 0    if purchase_num_dsl != 0:        purchase_mean_dsl = int(purchase_sum_dsl/purchase_num_dsl)    else: purchase_mean_dsl = 0    if (purchase_num_4g + purchase_num_dsl) != 0:        purchase_total_mean = int((purchase_sum_dsl+purchase_sum_4g)/(purchase_num_4g + purchase_num_dsl))    else: purchase_total_mean = 0    purchase_total_sum = purchase_sum_4g + purchase_sum_dsl    purchase_total_num = purchase_num_4g + purchase_num_dsl    purchase_str = purchase_str + "<tr bgcolor='#C1D3F0'><td>Purchases</td><td>${0}</td><td>{1}</td><td>${2}</td><td>${3}</td><td>{4}</td><td>${5}</td><td>${6}</td><td>{7}</td><td>${8}</td></tr>".format(purchase_sum_4g, purchase_num_4g, int(purchase_mean_4g), purchase_sum_dsl, purchase_num_dsl, int(purchase_mean_dsl), purchase_total_sum, purchase_total_num, purchase_total_mean)    renewed_str = "<tr bgcolor='#316ECE'><td colspan='10'></td></tr>"    renewed_sum_4g = 0    renewed_num_4g = 0    renewed_sum_dsl = 0    renewed_num_dsl = 0    for n in range(0, 3):        if table_renewed_4g[n][2] != 0:            renewed_mean_4g = int(table_renewed_4g[n][1] / table_renewed_4g[n][2])        else:            renewed_mean_4g = 0        if table_renewed_dsl[n][2] != 0:            renewed_mean_dsl = int(table_renewed_dsl[n][1] / table_renewed_dsl[n][2])        else:            renewed_mean_dsl = 0        renewed_sum_4g = renewed_sum_4g + table_renewed_4g[n][1]        renewed_num_4g = renewed_num_4g + table_renewed_4g[n][2]        renewed_sum_dsl = renewed_sum_dsl + table_renewed_dsl[n][1]        renewed_num_dsl = renewed_num_dsl + table_renewed_dsl[n][2]        if table_renewed_4g[n][2] + table_renewed_dsl[n][2] != 0:            renewed_mean = int((table_renewed_4g[n][1]+table_renewed_dsl[n][1])/(table_renewed_4g[n][2]+table_renewed_dsl[n][2]))        else: renewed_mean = 0        renewed_str = renewed_str + "<tr><td>{0}</td><td>${1}</td><td>{2}</td><td>${3}</td><td>${4}</td><td>{5}</td><td>${6}</td><td>${7}</td><td>{8}</td><td>${9}</td></tr>".format(            table_renewed_4g[n][0], table_renewed_4g[n][1], table_renewed_4g[n][2], int(renewed_mean_4g),            table_renewed_dsl[n][1], table_renewed_dsl[n][2], renewed_mean_dsl,            table_renewed_4g[n][1] + table_renewed_dsl[n][1], int(table_renewed_4g[n][2] + table_renewed_dsl[n][2]),            renewed_mean)    if renewed_num_4g != 0:        renewed_mean_4g = int(renewed_sum_4g / renewed_num_4g)    else:        renewed_mean_4g = 0    if renewed_num_dsl != 0:        renewed_mean_dsl = int(renewed_sum_dsl / renewed_num_dsl)    else:        renewed_mean_dsl = 0    if (renewed_num_4g + renewed_num_dsl) != 0:        renewed_total_mean = int((renewed_sum_dsl + renewed_sum_4g) / (renewed_num_4g + renewed_num_dsl))    else:        renewed_total_mean = 0    renewed_total_sum = renewed_sum_4g + renewed_sum_dsl    renewed_total_num = renewed_num_4g + renewed_num_dsl    renewed_str = renewed_str + "<tr bgcolor='#C1D3F0'><td>Renewals</td><td>${0}</td><td>{1}</td><td>${2}</td><td>${3}</td><td>{4}</td><td>${5}</td><td>${6}</td><td>{7}</td><td>${8}</td></tr>".format(        renewed_sum_4g, renewed_num_4g, int(renewed_mean_4g), renewed_sum_dsl, renewed_num_dsl,        int(renewed_mean_dsl), renewed_total_sum, renewed_total_num,        renewed_total_mean)    if purchase_total_num + renewed_total_num != 0:        total_mean = int((purchase_total_sum + renewed_total_sum)/(purchase_total_num + renewed_total_num))    else: total_mean = 0    if purchase_num_4g+renewed_num_4g != 0:        total_mean_4g = int((purchase_sum_4g+renewed_sum_4g)/(purchase_num_4g+renewed_num_4g))    else: total_mean_4g = 0    if purchase_num_dsl+renewed_num_dsl != 0:        total_mean_dsl = int((purchase_sum_dsl+renewed_sum_dsl)/(purchase_num_dsl+renewed_num_dsl))    else: total_mean_dsl = 0    total = "<tr bgcolor='#316ECE'><td>Total</td><td>${0}</td><td>{1}</td><td>${2}</td><td>${3}</td><td>{4}</td><td>${5}</td><td>${6}</td><td>{7}</td><td>${8}</td></tr>".format(purchase_sum_4g+renewed_sum_4g,purchase_num_4g+renewed_num_4g, total_mean_4g, purchase_sum_dsl+renewed_sum_dsl,purchase_num_dsl+renewed_num_dsl, total_mean_dsl, purchase_sum_4g+renewed_sum_4g + purchase_sum_dsl+renewed_sum_dsl, purchase_num_4g+renewed_num_4g + purchase_num_dsl+renewed_num_dsl,total_mean)    table_str = table_str + header + purchase_str +renewed_str + total + "</table>"    message = """\                <META HTTP-EQUIV="Content-Type" CONTENT="text/html">                <HTML>                </HEAD>                <BODY dir=ltr>                <DIV dir=ltr>                <DIV style="FONT-FAMILY: 'Arial'; COLOR: #000000; FONT-SIZE: 10pt">                <DIV>&nbsp;</DIV>                <BR>                {0}                <BR>                </BODY></HTML>                """.format(table_str)    if settings.mode == "test":        to_manager = ["artsiom.lubinsky@gmail.com"]    else:        to_manager = ["manager@dslrentals.com", "agalanin@live.com", "anton@dslrentals.com"]    send_email(email_conn, to_manager, subject, message)def send_email(email_conn, receiver_email, subject, html_text):    try:        to_list = receiver_email        the_msg = MIMEMultipart("alternative")        the_msg['Subject'] = subject        the_msg['From'] = settings.notify_from_email        the_msg['To'] = receiver_email[0]        message = MIMEText(html_text, "html")        the_msg.attach(message)        email_conn.sendmail(settings.notify_from_email, to_list, the_msg.as_string())        logs.write_to_log("Delivered {0}".format(receiver_email[0]))    except smtplib.SMTPException:        print("Error sending message to: {0}".format(receiver_email[0]))        logs.write_to_errors("NOT Delivered {0} {1}".format(receiver_email[0], smtplib.SMTPException.strerror))    return